<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fregments/header :: head"></head>
<body>

<th:block th:replace="fregments/header :: header"></th:block>

<div class="container mt-5 mb-5">

    <div class="card shadow-soft">
        <div class="card-body">

            <!-- 제목 -->
            <h2 class="page-title" th:text="${inquiry.title}">문의 제목</h2>

            <!-- 정보 영역 -->
            <p class="text-muted mb-1">
                작성자: <b th:text="${inquiry.member.username}"></b> ·
                <span th:text="${#temporals.format(inquiry.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
            </p>

            <p class="mt-1 mb-4">
                <strong>상태:</strong>
                <span th:switch="${inquiry.status.toString().toUpperCase()}">
                    <span th:case="'PENDING'" class="badge bg-warning text-dark">답변대기</span>
                    <span th:case="'ANSWERED'" class="badge bg-success">답변완료</span>
                    <span th:case="'CLOSED'" class="badge bg-secondary">종료</span>
                    <span th:case="*" class="badge bg-light text-dark">알수없음</span>
                </span>
            </p>

            <hr>

            <!-- 문의 본문 -->
            <h5 class="fw-bold">문의 내용</h5>
            <p class="mb-4" style="white-space: pre-line;"
               th:text="${inquiry.content}"></p>

            <hr>

            <!-- 답변 리스트 -->
            <h5 class="mt-4 mb-3">답변</h5>

            <div th:if="${#lists.isEmpty(replies)}"
                 class="alert alert-info shadow-sm text-center">
                아직 답변이 없습니다.
            </div>

            <div th:each="reply : ${replies}"
                 class="card bg-light p-3 mb-3 border-0 shadow-sm">

                <p class="mb-2" style="white-space: pre-line;"
                   th:text="${reply.content}"></p>

                <small class="text-muted">
                    작성자:
                    <span th:text="${reply.member.username}"></span> ·
                    <span th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                </small>

                <!-- 수정/삭제 -->
                <div class="mt-2"
                     th:if="${#authentication.principal.member.role.name() == 'ADMIN'
                            or #authentication.principal.member.id == reply.member.id}">

                    <button class="btn btn-sm btn-outline-primary"
                            th:onclick="|document.getElementById('replyEdit__${reply.id}').classList.toggle('d-none')|">
                        수정
                    </button>

                    <form th:action="@{'/inquiry/reply/delete/' + ${reply.id}}"
                          method="post" style="display:inline;"
                          onsubmit="return confirm('정말 삭제하시겠습니까?');">

                        <!-- inquiryId 추가 -->
                        <input type="hidden" name="inquiryId" th:value="${inquiry.id}">

                        <button class="btn btn-sm btn-outline-danger">삭제</button>
                    </form>


                </div>

                <!-- 답변 수정 폼 -->
                <div th:id="'replyEdit__' + ${reply.id}"
                     class="mt-2 d-none">

                    <form th:action="@{/inquiry/reply/update}" method="post">

                        <!-- replyId는 이미 있음 -->
                        <input type="hidden" name="replyId" th:value="${reply.id}">

                        <!-- inquiryId 추가 -->
                        <input type="hidden" name="inquiryId" th:value="${inquiry.id}">

                        <textarea name="content" class="form-control mb-2"
                                  rows="3" th:text="${reply.content}"></textarea>

                        <button class="btn btn-primary btn-sm">수정 완료</button>
                    </form>

                </div>

            </div>

            <hr>

            <!-- 답변 작성 -->
            <div th:if="${#authentication.principal != null}">
                <h5 class="mb-3">답변 작성하기</h5>

                <form th:action="@{/inquiry/reply/write}" method="post">
                    <input type="hidden" name="inquiryId" th:value="${inquiry.id}">

                    <textarea name="content" class="form-control mb-2" rows="3"
                              placeholder="답변 내용을 입력하세요" required></textarea>

                    <button class="btn btn-secondary">답변 작성</button>
                </form>
            </div>

            <div class="mt-4">
                <a th:href="@{/inquiry}" class="btn btn-outline-dark">
                    ← 문의 목록으로 돌아가기
                </a>
            </div>

        </div>
    </div>

</div>

<th:block th:replace="fregments/footer :: footer"></th:block>
</body>
</html>
