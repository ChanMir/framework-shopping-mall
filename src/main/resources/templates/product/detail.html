<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fregments/header :: head"></head>
<body>

<th:block th:replace="fregments/header :: header"></th:block>

<div class="container mt-5 mb-5">

    <div class="row">

        <!-- 상품 이미지 -->
        <div class="col-md-5 mb-4">
            <img th:src="@{|/img/${product.imageUrl}|}"
                 class="img-fluid rounded shadow-soft">
        </div>

        <!-- 상품 정보 -->
        <div class="col-md-7">
            <h2 class="page-title" th:text="${product.name}">상품명</h2>

            <h4 class="fw-bold text-danger mt-3"
                th:text="|${product.price}원|"></h4>

            <p class="mt-4" th:text="${product.description}"></p>

            <p class="text-muted">재고: <span th:text="${product.stock}"></span> 개</p>

            <a th:href="@{'/cart/add/' + ${product.id}}"
               class="btn btn-primary w-100 mt-3">장바구니 담기</a>

            <a th:href="@{/product}"
               class="btn btn-outline-secondary w-100 mt-2">상품 목록으로</a>

            <!-- 리뷰 작성 -->
            <hr class="mt-5 mb-4">
            <h3 class="mb-3">리뷰 작성</h3>

            <form th:action="@{/review/write}" method="post">
                <input type="hidden" name="productId" th:value="${product.id}" />

                <label class="form-label">평점</label>
                <select name="rating" class="form-select mb-2" required>
                    <option value="5">⭐⭐⭐⭐⭐ (5점)</option>
                    <option value="4">⭐⭐⭐⭐ (4점)</option>
                    <option value="3">⭐⭐⭐ (3점)</option>
                    <option value="2">⭐⭐ (2점)</option>
                    <option value="1">⭐ (1점)</option>
                </select>

                <textarea name="content" class="form-control mb-2"
                          rows="3" placeholder="리뷰를 입력하세요" required></textarea>

                <button class="btn btn-primary">리뷰 작성</button>
            </form>

        </div>
    </div>

    <!-- 리뷰 리스트 -->
    <hr class="mt-5 mb-4">
    <h3 class="mb-4">상품 리뷰</h3>

    <div th:each="r : ${reviews}"
         th:if="${r.active}"
         class="card mb-4 shadow-soft">

        <div class="card-body">

            <h5 class="mb-1">
                <span class="text-warning"
                      th:text="${#strings.repeat('⭐', r.rating)}"></span>
            </h5>

            <p class="mb-2" th:text="${r.content}"></p>

            <small class="text-muted">
                <span th:text="${r.member.username}"></span> •
                <span th:text="${#temporals.format(r.createdAt,'yyyy-MM-dd HH:mm')}"></span>
            </small>

            <!-- 리뷰 수정/삭제 -->
            <div th:if="${#authentication.principal.member.id == r.member.id}"
                 class="mt-2">

                <button class="btn btn-sm btn-outline-primary"
                        th:onclick="|document.getElementById('editReviewForm__${r.id}').classList.toggle('d-none')|">
                    리뷰 수정
                </button>

                <form th:action="@{'/review/delete/' + ${r.id}}"
                      method="post" style="display:inline;"
                      onsubmit="return confirm('삭제할까요?');">
                    <button class="btn btn-sm btn-outline-danger">삭제</button>
                </form>

            </div>

            <!-- 리뷰 수정 폼 -->
            <div th:id="'editReviewForm__' + ${r.id}"
                 class="d-none mt-3">

                <form th:action="@{/review/update}" method="post">
                    <input type="hidden" name="reviewId" th:value="${r.id}" />

                    <label class="form-label">평점</label>
                    <select name="rating" class="form-select mb-2">
                        <option th:each="i : ${#numbers.sequence(1,5)}"
                                th:value="${i}"
                                th:text="${i}"
                                th:selected="${i == r.rating}">
                        </option>
                    </select>

                    <textarea name="content" class="form-control mb-2"
                              th:text="${r.content}"></textarea>

                    <button class="btn btn-primary btn-sm">수정 완료</button>
                </form>
            </div>

            <hr>

            <!-- 댓글 -->
            <h6 class="mb-2">댓글</h6>

            <div th:each="c : ${commentMap[r.id]}"
                 th:if="${c.active}"
                 class="mb-2 border p-2 rounded bg-light">

                <p class="mb-1" th:text="${c.content}"></p>

                <small class="text-muted">
                    <span th:text="${c.member.username}"></span> •
                    <span th:text="${#temporals.format(c.createdAt,'yyyy-MM-dd HH:mm')}"></span>
                </small>

                <div th:if="${#authentication.principal.member.id == c.member.id}"
                     class="mt-1">

                    <button class="btn btn-sm btn-outline-secondary"
                            th:onclick="|document.getElementById('editComment__${c.id}').classList.toggle('d-none')|">
                        수정
                    </button>

                    <form th:action="@{'/comment/delete/' + ${c.id}}"
                          method="post" style="display:inline;"
                          onsubmit="return confirm('삭제할까요?');">
                        <button class="btn btn-sm btn-outline-danger">삭제</button>
                    </form>
                </div>

                <!-- 댓글 수정 -->
                <div th:id="'editComment__' + ${c.id}"
                     class="d-none mt-2">

                    <form th:action="@{/comment/update}" method="post">
                        <input type="hidden" name="commentId" th:value="${c.id}" />
                        <textarea name="content" class="form-control mb-2"
                                  th:text="${c.content}"></textarea>
                        <button class="btn btn-primary btn-sm">수정 완료</button>
                    </form>
                </div>
            </div>

            <!-- 댓글 작성 -->
            <form class="mt-3" th:action="@{/comment/write}" method="post">
                <input type="hidden" name="reviewId" th:value="${r.id}" />
                <textarea name="content" class="form-control mb-2"
                          placeholder="댓글을 입력하세요" required></textarea>
                <button class="btn btn-secondary btn-sm">댓글 작성</button>
            </form>

        </div>
    </div>

</div>

<th:block th:replace="fregments/footer :: footer"></th:block>
</body>
</html>
